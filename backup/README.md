# Настройка backup

## Базовые настройки после установки операционной системы

Установка сетевых параметров, имени компьютера, включение в домен

```powershell
New-NetIPAddress -InterfaceAlias "Ethernet0" -IPAddress 192.168.69.9 -PrefixLength 24 -DefaultGateway 192.168.69.254
Set-DnsClientServerAddress -InterfaceAlias "Ethernet0" -ServerAddresses ("192.168.69.1","192.168.69.2")
New-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters\" -Name "DisabledComponents" -Value 0xffffffff -PropertyType "DWord"
slmgr.vbs -ipk VDYBN-27WPP-V4HQT-9VMD4-VMK7H
Add-Computer -NewName "BACKUP" -DomainName "domain.lab" -OUPath "OU=Domain Servers,DC=domain,DC=lab" -Credential "Администратор@domain.lab" -Restart -Force
```

## Установка и настройка Veeam Backup & Replication

Предварительных требований для установки нет. Просто запускаем установку Veeam из iso образа.

После установки Veeam Backup & Replication его настройка осуществляется через консоль управления и состоит из следующих этапов:
- общая настройка
- создание репозиториев (хранилищ резервных копий)
- подключение к серверу управления виртуальной инфраструктурой vCenter
- создание заданий резервного копирования

### Общая настройка

- В главном меню консоли выбрать перейти в меню `Options`, осуществить настройку оповещений по электронной почте, указав адрес почтового сервера, источник сообщений и адресата сообщений.
- Добавить учетные записи администратора домена `Администратор@domain.lab`, администратора домена vCenter `administrator@vsphere.local`, локального администратора `root` хоста ESXi, на котором размещен VCSA. Для этого необходимо в главном меню консоли перейти в меню `Manage Credentials` и добавить указанные учетные записи нажав на кнопку `Add`.

### Создание репозиториев (хранилищ резервных копий)

По-умолчанию при установке создается репозиторий на диске `D:\`. Для создания и настройки дополнительного репозитория необходимо перейти в раздел консоли `Backup Infrastructure`, выделить `Backup Repositories` и в контекстном меню выбрать `Add Backup Repository`.

### Подключение к серверу управления виртуальной инфраструктурой vCenter

Далее необходимо создать подключение к серверу управления виртуальной инфраструктурой и хосту, содержащему VCSA. Для этого необходимо перейти в раздел консоли `Backup Infrastructure`, выделить `Managed Servers` и выбрать `Add Server VMware vSphere`.

В открывшемся окне поочередно ввести адрес `vcsa.domain.lab` и `esx1.domain.lab` хоста с виртуальной машиной VCSA. Указать для VCSA учетную запись `administrator@vsphere.local`, а для самого хоста ESXi локального администратора `root`. 

Использование локального пользователя root при подключении к хосту необходимо для корректного резервного копирования VCSA. Использование доменных учетных записей не рекомендуется по причине того, что в случае выхода из строя контроллеров домена, подключение Veeam к VCSA будет утеряно.

### Создание заданий резервного копирования

После создания репозитория и подключения к виртуальной инфраструктуре можно переходить к созданию заданий резервного копирования. 

Для этого необходимо перейти в раздел консоли и выбрать `Backup Job`. В открывшемся окне ввести имя задания и **выбрать виртуальные машины** на сервера vCenter (либо папку) подлежащие резервному копированию.

При выборе виртуальных машин резервного копирования необходимо учитывать следующее:
- не допускается добавлять в задание резервного копирования виртуальную машину содержащую сам Veeam Backup & Replication.
- при выборе виртуальных машин через vCenter не рекомендуется добавлять виртуальную машину, содержащую непосредственно сам vCenter, по причине того, что в процессе резервного копирования происходит обмен служебной информацией между Veeam и vCenter, а в случае резервного копирования vCenter обмен служебной информацией с Veeam может быть прерван. Для решения данной проблемы ранее было создано подключение с использованием локальной учетной записи `root` непосредственно к самому хосту ESXi, содержащего vCenter, и, в случае резервного копирования виртуальной машины с vCenter через хост ESXi, обмен служебной информацией будет осуществляется между Veeam и хостом ESXi, без участия vCenter.

После выбора виртуальных машин необходимо указать репозиторий, указать количество хранимых точек восстановления (не менее 7) и нажав на кнопку `Advanced` указать дополнительные параметры резервного копирования.
- Во вкладке `Backup` настраивается схема резервного копирования. Рекомендуется использование инкрементной схемы с созданием еженедельных полных копий. При данной схеме резервного копирования при первом запуске будет создана полная копия виртуальных машин. Далее в течении недели будут создаваться инкрементные копии, содержащие только блоки данных которые были изменены в сравнении с полной копией.
- Во вкладке `Storage` необходимо включить дедупликацию для экономии дискового пространства. 
- Во вкладке `vSphere` включить `Guest quiescence` и `Changed block tracking`.
- Во вкладке `Advanced` осуществляется настройка обработки операционных систем виртуальных машин (Guest processing). Для обеспечения корректного резервного копирования контроллеров домена, почтовых серверов, серверов баз данных, необходимо включить `Enable application-aware image processing` и выбрать учетную запись администратора домена `Администратор@domain.lab`.

Завершающим шагом создания задания резервного копирования является установка расписания резервного копирования. Необходимо установить ежедневный запуск не ранее 19:00.

### Рекомендуемые задания резервного копирования

Рекомендуется создать как минимум 3 задания резервного копирования:
1. Задание `VCSA Backup` - подключение через ESXi, резервное копирование виртуальной машины **`vcsa.domain.lab`**, запуск по расписанию в 19:00
2. Задание `Virtual Infrastructure` - подключение через VCSA, резервное копирование 9 виртуальных машин в папке vCenter **`Production`**, запуск после задания `VCSA Backup`
3. Задание `File Servers` - подключение через VCSA, резервное копирование виртуальной машины **`fs1.domain.lab`**, запуск после задания `Virtual Infrastructure`